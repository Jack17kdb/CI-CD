stages:
  - build
  - test
  - deploy

build_app:
  stage: build
  image: python:3.12
  script:
    - echo "Building Flask app...."
    - mkdir build
    - cp -r flask-cicd/* build/
  artifacts:
    paths:
      - build/
    expire_in: 1 hour


test_flask_app:
  stage: test
  image: python:3.12
  before_script:
    - echo "Installing requirements...."
    - pip install -r build/requirements.txt
  script:
    - echo "Testing Flask app...."
    - python3 -m py_compile build/app.py
  dependencies:
    - build_app

deploy_app:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying Flask app to staging environment...."
    - mkdir -p flask-deploy
    - cp -r build/* flask-deploy/
    - echo "App deployed successfully!"
  dependencies:
    - build_app
  environment:
    name: staging
    url: https://staging.example.com
  when: manual
